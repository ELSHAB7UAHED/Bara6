name: Build BARA

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          unzip \
          git \
          python3-pip
        
    - name: Install Arduino CLI
      run: |
        # طريقة مباشرة - تحميل ثنائي Arduino CLI
        wget -q https://downloads.arduino.cc/arduino-cli/arduino-cli_latest_Linux_64bit.tar.gz
        tar -xzf arduino-cli_latest_Linux_64bit.tar.gz
        sudo mv arduino-cli /usr/local/bin/
        arduino-cli version
        
    - name: Setup Arduino
      run: |
        # التهيئة
        arduino-cli config init
        arduino-cli config set library.enable_unsafe_install true
        
        # إضافة ESP32
        arduino-cli config add board_manager.additional_urls \
          https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
        
        arduino-cli core update-index
        arduino-cli core install esp32:esp32
        
    - name: Install Libraries
      run: |
        arduino-cli lib install "ArduinoJson"
        arduino-cli lib install "WiFi"
        arduino-cli lib install "WebServer"
        
    - name: Verify Setup
      run: |
        arduino-cli core list
        arduino-cli lib list
        
    - name: Compile
      run: |
        # البحث عن ملف INO
        INO_FILE=$(find . -name "*.ino" | head -1)
        echo "Compiling: $INO_FILE"
        
        arduino-cli compile \
          --fqbn esp32:esp32:esp32 \
          --build-path ./build \
          $INO_FILE
        
    - name: Prepare Output
      run: |
        mkdir -p output
        
        # نسخ الملفات المهمة
        INO_FILE=$(find . -name "*.ino" | head -1)
        BASENAME=$(basename "$INO_FILE" .ino)
        
        cp "build/$BASENAME.ino.bin" output/firmware.bin
        cp "build/$BASENAME.ino.partitions.bin" output/partitions.bin
        
        # إنشاء ملف بسيط للتعليمات
        cat > output/README.txt << EOF
        BARA Demonic Suite
        ==================
        
        Files:
        - firmware.bin: Main firmware (flash at 0x10000)
        - partitions.bin: Partition table (flash at 0x8000)
        
        Flash using esptool:
        esptool.py --chip esp32 --port /dev/ttyUSB0 \\
          --baud 921600 write_flash \\
          0x1000 bootloader_dio_80m.bin \\
          0x8000 partitions.bin \\
          0x10000 firmware.bin
        EOF
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: output/
